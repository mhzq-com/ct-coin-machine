<!DOCTYPE html>
<html lang="hu-HU">

<head>
    <title>CityMediaCoinMachine</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="Keywords" content="node,js,nodejs,home,automation,homeautomation,statisztika,automatizálás">
    <meta name="Description" content="CityMediaCoinMachine">
    <!--<link rel="icon" href="/favicon.ico" type="image/x-icon">-->
    <script src="js/jquery-3.2.1.min.js"></script>
    <link href="css/jquery-ui.min.css" type="text/css" rel="stylesheet">
    <link href="css/keyboard.css" type="text/css" rel="stylesheet">
    <link href="css/animate.css" type="text/css" rel="stylesheet">
    <link href="css/component.css" type="text/css" rel="stylesheet">
    <link href="css/bootstrap-reboot.min.css" type="text/css" rel="stylesheet">
    <link href="css/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link href="css/site.css" type="text/css" rel="stylesheet">
    <link href="css/font-awesome/css/font-awesome.css" type="text/css" rel="stylesheet">


    <script src="js/jquery-ui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/jquery.keyboard.min.js"></script>
    <script src="js/socket.io.min.js"></script>
    <script src="js/modernizr.custom.js"></script>
    <script src="js/jquery.dlmenu.js"></script>
    <script src="js/Chart.bundle.min.js"></script>
    <script src="js/site.js"></script>
    <script>
        //prevent right click
        //document.addEventListener('contextmenu', event => event.preventDefault());
        $(function () {

            var serviceUnavailableCount = 0;

            $("#loginForm").on("submit", function (e) {
                e.preventDefault();
                var prodDiv = $("#loginForm");
                prodDiv.addClass("loading");
                prodDiv.find("button[type=submit]").prop("disabled", true);

                var password = $(this).find("input[name=pwd]").val();
                var user = $(this).find("input[name=uid]").val();


                $.post("api/Login", { user: user, password: password }, function (data) {
                    
                    window.location.href = "/index.html";

                    serviceUnavailableCount = 0;
                }, "json")
                .fail((xhr) => {
                    
                    var message = xhr.responseJSON.error_description || xhr.statusText;

                    if(xhr.status == 503){
                        serviceUnavailableCount++;
                    }

                    if(serviceUnavailableCount > 2){
                        $("#loginWithPinAsk").removeClass("d-none");
                    }

                    prodDiv.displayMessage({ message: message  });


                })
                .always(function () {
                    prodDiv.removeClass("loading");
                    prodDiv.find("button[type=submit]").prop("disabled", false);
                });
            });

            $("#loginWithPinAsk button").on("click", function(){
                $("#loginForm").hide("fast");
                $("#loginFormPin").removeClass("d-none").show("fast");
            });

            
            $("#loginFormPin").on("submit", function (e) {
                e.preventDefault();
                var prodDiv = $("#loginFormPin");
                prodDiv.addClass("loading");
                prodDiv.find("button[type=submit]").prop("disabled", true);

                var password = $(this).find("input[name=pwd]").val();


                $.post("api/LoginWithPin", { password: password }, function (data) {
                    
                    window.location.href = "/index.html";
                }, "json")
                .fail((xhr) => {
                    
                    var message = xhr.responseJSON.error_description || xhr.statusText;

                    prodDiv.displayMessage({ message: message  });


                })
                .always(function () {
                    prodDiv.removeClass("loading");
                    prodDiv.find("button[type=submit]").prop("disabled", false);
                });
            });



            $("#logout").click(function (e) {
                e.preventDefault();
                $(this).addClass("loading");

                $.post("api/Logout", {}, function (data) {
                    var success = data.success || false;

                    if (!success) {
                        $("#generalMessage").displayMessage({ message: data.error });
                        return;
                    }

                    window.location = "/index.html";

                }, "json").always(() => {
                    $(this).removeClass("loading");
                });

            });

        });
    </script>
</head>

<body>

    <h1 class="text-center">CityMediaCoinMachine</h1>

    <div class="row justify-content-center">
        <div class="col-md-2 border shadow p-5">
            <form id="loginForm" action="" method="POST">
                <div class="col-12">
                    <h1 class="text-center">Bejelentkezés</h1>
                    <p>${serialNumber}</p>
                </div>
                <div class="form-group">
                    <input id="Login_input1" class="text form-control" placeholder="Felhasználónév" type="text"
                        name="uid" value="" style="" ng-required="displayCondition">
                </div>
                <div class="form-group">
                    <input id="Login_input2" class="password form-control" placeholder="Jelszó" type="password"
                        name="pwd" value="" style="" ng-required="displayCondition">
                </div>

                <div class="form-group">
                    <div class="form-group">

                        <button id="Login_submitButton" class="button btn btn-primary form-control" name="login"
                            type="submit" title="" value="" style="" data-cfl_column="" data-query_object=""
                            data-query_params="" data-class="">Bejelentkezés</button>

                    </div>
                </div>

                <div id="loginWithPinAsk" class="d-none form-group">
                    <p>Nem elérhető a szerver?</p>
                    <button class="button btn btn-primary form-control" >Bejelentkezés PIN kóddal</button>
                </div>

            </form>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-2 border shadow p-5">
            <form id="loginFormPin" class="d-none" action="" method="POST">
                <div class="col-12">
                    <h1 class="text-center">Bejelentkezés</h1>
                </div>
                <div class="form-group">
                    <input id="Login_input2" class="password form-control" placeholder="PIN" type="password"
                        name="pwd" value="" style="" ng-required="displayCondition">
                </div>

                <div class="form-group">
                    <div class="form-group">

                        <button id="Login_submitButton" class="button btn btn-primary form-control" name="login" >Bejelentkezés</button>

                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- <div id="dl-menu" class="dl-menuwrapper">

        <button class="button dl-trigger dl-active"></button>

        <span>Menü</span>
        <ul class="dl-menu">
            <li>
                <a id="logout" href="#" type="button">Vissza</a>
            </li>

        </ul>
    </div> -->
</body>

</html>